<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏资源下载工具</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F484V88GBJ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-F484V88GBJ');
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5;
            min-height: 100vh;
        }
        .navbar {
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            color: white !important;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .nav-link {
            color: rgba(255,255,255,0.9) !important;
            transition: all 0.3s;
            margin: 0 5px;
        }
        .nav-link:hover {
            color: white !important;
            transform: translateY(-2px);
        }
        .nav-link.active {
            color: white !important;
            background-color: rgba(255,255,255,0.15);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .main-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 20px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            transition: all 0.3s;
            background: white;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-bottom: 1px solid #eee;
            padding: 20px 25px;
            border-radius: 15px 15px 0 0 !important;
        }
        .card-title {
            margin: 0;
            color: #1a237e;
            font-weight: 600;
            font-size: 1.2rem;
        }
        .card-body {
            padding: 25px;
        }
        .progress {
            height: 12px;
            border-radius: 6px;
            margin: 20px 0;
            background-color: #e3f2fd;
        }
        .progress-bar {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        }
        .btn-primary {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            border: none;
            padding: 12px 30px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            border: none;
            padding: 12px 30px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        #result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .success {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        .error {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #1a237e;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #546e7a;
            font-size: 14px;
            font-weight: 500;
        }
        .coming-soon {
            position: relative;
            overflow: hidden;
        }
        .coming-soon::after {
            content: "即将推出";
            position: absolute;
            top: 15px;
            right: -35px;
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            padding: 6px 45px;
            transform: rotate(45deg);
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(244, 67, 54, 0.3);
        }
        .table {
            margin-bottom: 0;
        }
        .table th {
            font-weight: 600;
            color: #1a237e;
            border-top: none;
        }
        .table td {
            vertical-align: middle;
        }
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        .btn-outline-primary {
            border-color: #2196f3;
            color: #2196f3;
        }
        .btn-outline-primary:hover {
            background-color: #2196f3;
            color: white;
        }
        .system-status {
            padding: 10px 0;
        }
        .status-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-item i {
            font-size: 1.2rem;
        }
        .status-item span {
            color: #546e7a;
            font-weight: 500;
        }
        @media (max-width: 991.98px) {
            .main-container {
                padding: 15px;
            }
            .card {
                margin-bottom: 20px;
            }
            .stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-controller me-2"></i>游戏资源下载工具
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#html5games" data-target="html5games-section">
                            <i class="bi bi-globe me-1"></i>HTML5games网页
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#images" data-target="image-downloader-section">
                            <i class="bi bi-images me-1"></i>图片下载器
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#resize" data-target="image-resize-section">
                            <i class="bi bi-aspect-ratio me-1"></i>图片尺寸调整
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link coming-soon" href="#">
                            <i class="bi bi-cloud-download me-1"></i>其他下载器
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="row">
            <!-- 左侧主要内容区域 -->
            <div class="col-lg-8">
                <!-- HTML5游戏下载器 -->
                <div id="html5games-section">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-globe me-2"></i>HTML5游戏链接获取
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <button id="startBtn" class="btn btn-primary btn-lg">
                                    <i class="bi bi-play-fill me-2"></i>开始获取游戏链接
                                </button>
                            </div>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="result"></div>
                            <div class="text-center">
                                <button id="downloadBtn" class="btn btn-success">
                                    <i class="bi bi-download me-2"></i>下载结果
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 最近获取记录 -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-clock-history me-2"></i>最近获取记录
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>时间</th>
                                            <th>游戏数量</th>
                                            <th>成功数</th>
                                            <th>失败数</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historyTable">
                                        <!-- 历史记录将通过JavaScript动态添加 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 图片下载器部分 -->
                <div id="image-downloader-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-images me-2"></i>图片下载器
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="imageUrlInput" class="form-label">目标网页URL</label>
                                <input type="text" class="form-control" id="imageUrlInput" placeholder="https://example.com">
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-9">
                                    <label for="imageFormat" class="form-label">保存图片格式</label>
                                    <select class="form-select" id="imageFormat">
                                        <option value="auto" selected>自动识别</option>
                                        <option value="jpg">强制JPG</option>
                                        <option value="png">强制PNG</option>
                                        <option value="svg">保留SVG格式</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="jpgQuality" class="form-label">JPG质量</label>
                                    <select class="form-select" id="jpgQuality">
                                        <option value="0.7">低</option>
                                        <option value="0.85" selected>中</option>
                                        <option value="0.95">高</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-center mb-4">
                                <button id="startImageBtn" class="btn btn-primary">
                                    <i class="bi bi-search me-2"></i>获取图片链接
                                </button>
                            </div>
                            <div class="progress" id="imageProgress" style="display:none;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="imageResult" style="display:none;"></div>
                            <div class="text-center mt-3">
                                <button id="downloadImagesBtn" class="btn btn-success" style="display:none;">
                                    <i class="bi bi-download me-2"></i>下载全部图片
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 图片预览 -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-eye me-2"></i>图片预览
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="imagesPreview" style="display:none;">
                                <h6>预览 (最多显示9张):</h6>
                                <div class="row g-2 images-container">
                                    <!-- 图片预览区域 -->
                                </div>
                            </div>
                            <div class="text-center text-muted" id="no-preview">
                                <i class="bi bi-image" style="font-size: 3rem;"></i>
                                <p class="mt-2">获取图片后将在此处显示预览</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 图片尺寸调整部分 -->
                <div id="image-resize-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-aspect-ratio me-2"></i>图片尺寸调整
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="imageUpload" class="form-label">上传图片</label>
                                <input class="form-control" type="file" id="imageUpload" accept="image/*" multiple>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="widthInput" class="form-label">宽度 (像素)</label>
                                    <input type="number" class="form-control" id="widthInput" placeholder="宽度" value="1280">
                                </div>
                                <div class="col-md-6">
                                    <label for="heightInput" class="form-label">高度 (像素)</label>
                                    <input type="number" class="form-control" id="heightInput" placeholder="高度" value="720">
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="aspectRatio" id="noRatio" value="none">
                                    <label class="form-check-label" for="noRatio">
                                        自定义尺寸
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="aspectRatio" id="originalRatio" value="original">
                                    <label class="form-check-label" for="originalRatio">
                                        保持原图比例
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="aspectRatio" id="ratio16_9" value="16:9" checked>
                                    <label class="form-check-label" for="ratio16_9">
                                        16:9比例
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="aspectRatio" id="ratio4_3" value="4:3">
                                    <label class="form-check-label" for="ratio4_3">
                                        4:3比例
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="aspectRatio" id="ratio1_1" value="1:1">
                                    <label class="form-check-label" for="ratio1_1">
                                        1:1比例 (正方形)
                                    </label>
                                </div>
                            </div>
                            <div class="progress mb-3" id="resizeProgress" style="display:none;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="text-center">
                                <button id="resizeBtn" class="btn btn-primary">
                                    <i class="bi bi-arrows-angle-expand me-2"></i>调整尺寸
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 图片预览 -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="bi bi-eye me-2"></i>调整后预览
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="resizedImagesPreview" style="display:none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">调整后预览:</h6>
                                    <button id="downloadResizedBtn" class="btn btn-success btn-sm">
                                        <i class="bi bi-download me-1"></i>下载全部
                                    </button>
                                </div>
                                <div class="row g-2 resized-images-container">
                                    <!-- 调整尺寸后的图片预览区域 -->
                                </div>
                            </div>
                            <div class="text-center text-muted" id="no-resize-preview">
                                <i class="bi bi-arrows-angle-expand" style="font-size: 3rem;"></i>
                                <p class="mt-2">上传并调整图片后将在此处显示预览</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧信息区域 -->
            <div class="col-lg-4">
                <!-- 统计信息 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="bi bi-graph-up me-2"></i>统计信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="stats">
                            <div class="stat-item">
                                <div class="stat-value" id="totalGames">0</div>
                                <div class="stat-label">总游戏数</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="successCount">0</div>
                                <div class="stat-label">成功获取</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="failCount">0</div>
                                <div class="stat-label">获取失败</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系统状态 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="bi bi-gear me-2"></i>系统状态
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="system-status">
                            <div class="status-item">
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                <span>代理服务正常</span>
                            </div>
                            <div class="status-item">
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                <span>网络连接正常</span>
                            </div>
                            <div class="status-item">
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                <span>存储空间充足</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 更新提示卡片 -->
                <div class="card coming-soon">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="bi bi-cloud-download me-2"></i>其他下载器
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted text-center">更多下载器即将推出...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let gameLinks = [];
        let totalGames = 0;
        let successCount = 0;
        let failCount = 0;
        
        // 图片下载器统计信息
        let totalImages = 0;
        let downloadedImages = 0;
        let failedImages = 0;
        
        // 图片尺寸调整统计信息
        let totalResizeImages = 0;
        let resizedSuccessCount = 0;
        let resizedFailCount = 0;

        function updateStats(mode = 'games') {
            try {
                // 检查元素是否存在，如果不存在则给出错误提示
                const totalElement = document.getElementById('totalGames');
                const successElement = document.getElementById('successCount');
                const failElement = document.getElementById('failCount');
                
                if (!totalElement || !successElement || !failElement) {
                    console.error('统计信息元素不存在！请检查HTML结构。');
                    console.log('缺少的元素:', 
                        !totalElement ? 'totalGames' : '', 
                        !successElement ? 'successCount' : '', 
                        !failElement ? 'failCount' : '');
                    return;
                }
                
                // 根据不同模式更新统计数据
                if (mode === 'games') {
                    totalElement.textContent = totalGames;
                    successElement.textContent = successCount;
                    failElement.textContent = failCount;
                    
                    // 更新标签文本
                    document.querySelector('.stat-label:nth-child(2)').textContent = '总游戏数';
                    document.querySelector('.stat-label:nth-child(4)').textContent = '成功获取';
                    document.querySelector('.stat-label:nth-child(6)').textContent = '获取失败';
                } else if (mode === 'images') {
                    totalElement.textContent = totalImages;
                    successElement.textContent = downloadedImages;
                    failElement.textContent = failedImages;
                    
                    // 更新标签文本
                    document.querySelector('.stat-label:nth-child(2)').textContent = '总图片数';
                    document.querySelector('.stat-label:nth-child(4)').textContent = '已下载';
                    document.querySelector('.stat-label:nth-child(6)').textContent = '下载失败';
                } else if (mode === 'resize') {
                    totalElement.textContent = totalResizeImages;
                    successElement.textContent = resizedSuccessCount;
                    failElement.textContent = resizedFailCount;
                    
                    // 更新标签文本
                    document.querySelector('.stat-label:nth-child(2)').textContent = '总图片数';
                    document.querySelector('.stat-label:nth-child(4)').textContent = '调整成功';
                    document.querySelector('.stat-label:nth-child(6)').textContent = '调整失败';
                }
            } catch (error) {
                console.error('更新统计信息时出错:', error);
            }
        }

        async function fetchWithCORS(url) {
            try {
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const response = await fetch(proxyUrl + encodeURIComponent(url));
                return await response.text();
            } catch (error) {
                console.error('Error fetching:', error);
                throw error;
            }
        }

        async function getGamePages() {
            const baseUrl = "https://html5games.com";
            const url = `${baseUrl}/All-Games`;
            
            try {
                const html = await fetchWithCORS(url);
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const gameLinks = [];
                const gameElements = doc.querySelectorAll('a[href^="/Game/"]');
                
                gameElements.forEach(game => {
                    const href = game.getAttribute('href');
                    if (href && href.startsWith('/Game/')) {
                        gameLinks.push(baseUrl + href);
                    }
                });
                
                return gameLinks;
            } catch (error) {
                console.error('获取游戏列表时发生错误:', error);
                return [];
            }
        }

        async function getGameTextareaLink(gameUrl) {
            try {
                const html = await fetchWithCORS(gameUrl);
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const textarea = doc.querySelector('textarea');
                if (textarea) {
                    return textarea.textContent.trim();
                }
                return null;
            } catch (error) {
                console.error('获取游戏textarea链接时发生错误:', error);
                return null;
            }
        }

        function downloadResults(results) {
            const content = results.map(result => 
                `游戏页面: ${result.url}\nTextarea链接: ${result.link}\n${'-'.repeat(50)}\n`
            ).join('\n');
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'game_textarea_links.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 添加历史记录功能
        let history = JSON.parse(localStorage.getItem('crawlHistory') || '[]');

        function addToHistory(total, success, fail) {
            const record = {
                time: new Date().toLocaleString(),
                total,
                success,
                fail
            };
            history.unshift(record);
            if (history.length > 10) history.pop(); // 只保留最近10条记录
            localStorage.setItem('crawlHistory', JSON.stringify(history));
            updateHistoryTable();
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = history.map(record => `
                <tr>
                    <td>${record.time}</td>
                    <td>${record.total}</td>
                    <td class="text-success">${record.success}</td>
                    <td class="text-danger">${record.fail}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="downloadHistoryRecord(${JSON.stringify(record)})">
                            <i class="bi bi-download"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function downloadHistoryRecord(record) {
            const content = `获取时间: ${record.time}\n总游戏数: ${record.total}\n成功数: ${record.success}\n失败数: ${record.fail}\n${'-'.repeat(50)}`;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crawl_history_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('startBtn').addEventListener('click', async function() {
            const button = this;
            const progress = document.querySelector('.progress');
            const progressBar = document.querySelector('.progress-bar');
            const result = document.getElementById('result');
            const downloadBtn = document.getElementById('downloadBtn');
            
            button.disabled = true;
            progress.style.display = 'block';
            result.style.display = 'none';
            downloadBtn.style.display = 'none';
            gameLinks = [];
            
            // 重置统计
            totalGames = 0;
            successCount = 0;
            failCount = 0;
            updateStats();
            
            try {
                const gamePages = await getGamePages();
                
                if (!gamePages.length) {
                    throw new Error('未找到游戏页面');
                }
                
                totalGames = gamePages.length;
                updateStats();
                
                const results = [];
                for (let i = 0; i < gamePages.length; i++) {
                    const gameUrl = gamePages[i];
                    const textareaLink = await getGameTextareaLink(gameUrl);
                    
                    if (textareaLink) {
                        results.push({ url: gameUrl, link: textareaLink });
                        successCount++;
                    } else {
                        failCount++;
                    }
                    
                    // 更新进度条
                    const progress = ((i + 1) / gamePages.length) * 100;
                    progressBar.style.width = `${progress}%`;
                    
                    // 更新统计
                    updateStats();
                    
                    // 添加延时避免请求过快
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                gameLinks = results;
                result.style.display = 'block';
                result.className = 'success';
                result.textContent = `共找到 ${results.length} 个游戏textarea链接`;
                downloadBtn.style.display = 'inline-block';
                progressBar.classList.add('bg-success');
                
                // 在成功完成后添加历史记录
                addToHistory(totalGames, successCount, failCount);
                
            } catch (error) {
                result.style.display = 'block';
                result.className = 'error';
                result.textContent = '发生错误：' + error.message;
                progressBar.classList.add('bg-danger');
            } finally {
                button.disabled = false;
            }
        });

        document.getElementById('downloadBtn').addEventListener('click', function() {
            if (gameLinks.length > 0) {
                downloadResults(gameLinks);
            }
        });

        // 页面加载时显示历史记录
        updateHistoryTable();
        
        // 根据初始激活的导航项设置统计模式
        const activeNav = document.querySelector('.nav-link.active');
        if (activeNav) {
            const targetId = activeNav.getAttribute('data-target');
            if (targetId === 'html5games-section') {
                updateStats('games');
            } else if (targetId === 'image-downloader-section') {
                updateStats('images');
            } else if (targetId === 'image-resize-section') {
                updateStats('resize');
            }
        } else {
            // 默认显示游戏统计
            updateStats('games');
        }

        // 导航切换功能
        document.querySelectorAll('.nav-link').forEach(link => {
            if (!link.classList.contains('coming-soon')) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 移除所有活跃状态
                    document.querySelectorAll('.nav-link').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // 添加活跃状态到当前点击项
                    this.classList.add('active');
                    
                    // 隐藏所有内容区域
                    document.querySelectorAll('#html5games-section, #image-downloader-section, #image-resize-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // 显示目标内容区域
                    const targetId = this.getAttribute('data-target');
                    document.getElementById(targetId).style.display = 'block';
                    
                    // 根据当前显示的内容更新统计信息
                    if (targetId === 'html5games-section') {
                        updateStats('games');
                    } else if (targetId === 'image-downloader-section') {
                        updateStats('images');
                    } else if (targetId === 'image-resize-section') {
                        updateStats('resize');
                    }
                });
            }
        });

        // 图片下载器功能
        let imageLinks = [];
        
        document.getElementById('startImageBtn').addEventListener('click', async function() {
            const imageUrl = document.getElementById('imageUrlInput').value.trim();
            if (!imageUrl) {
                alert('请输入目标网页URL');
                return;
            }
            
            const button = this;
            const progress = document.getElementById('imageProgress');
            const progressBar = progress.querySelector('.progress-bar');
            const result = document.getElementById('imageResult');
            const downloadBtn = document.getElementById('downloadImagesBtn');
            const previewContainer = document.getElementById('imagesPreview');
            const noPreview = document.getElementById('no-preview');
            
            button.disabled = true;
            progress.style.display = 'block';
            result.style.display = 'none';
            downloadBtn.style.display = 'none';
            previewContainer.style.display = 'none';
            noPreview.style.display = 'block';
            imageLinks = [];
            
            // 重置图片统计
            totalImages = 0;
            downloadedImages = 0;
            failedImages = 0;
            updateStats('images');
            try {
                // 获取网页内容
                const html = await fetchWithCORS(imageUrl);
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // 获取所有图片元素
                const imgElements = doc.querySelectorAll('img');
                const baseUrl = new URL(imageUrl).origin;
                
                progressBar.style.width = '50%';
                
                // 处理图片链接
                imgElements.forEach(img => {
                    let src = img.getAttribute('src');
                    if (src) {
                        // 转换为绝对URL
                        if (src.startsWith('//')) {
                            src = 'https:' + src;
                        } else if (src.startsWith('/')) {
                            src = baseUrl + src;
                        } else if (!src.startsWith('http')) {
                            try {
                                src = new URL(src, imageUrl).href;
                            } catch (e) {
                                console.error('无法解析URL:', src);
                            }
                        }
                        
                        // 过滤掉数据URI
                        if (src && !src.startsWith('data:')) {
                            // 查找图片下方的命名div
                            let name = '';
                            
                            // 调试信息 - 记录初始状态
                            console.log('开始查找图片名称:', src);
                            
                            // 先检查父元素的下一个兄弟元素是否含有name类
                            const parent = img.parentElement;
                            if (parent) {
                                // 遍历父元素的所有子元素，寻找img之后的div.name
                                let foundImg = false;
                                for (let i = 0; i < parent.children.length; i++) {
                                    const child = parent.children[i];
                                    if (foundImg && child.classList && child.classList.contains('name')) {
                                        name = child.textContent.trim();
                                        console.log('找到名称(方法1-父元素子元素):', name);
                                        break;
                                    }
                                    if (child === img) {
                                        foundImg = true;
                                    }
                                }
                                
                                // 如果没找到，检查父元素的下一个兄弟元素
                                if (!name && parent.nextElementSibling) {
                                    const nextSibling = parent.nextElementSibling;
                                    if (nextSibling.classList && nextSibling.classList.contains('name')) {
                                        name = nextSibling.textContent.trim();
                                        console.log('找到名称(方法2-父元素兄弟):', name);
                                    }
                                }
                                
                                // 如果仍然没找到，向上查找更多的父级元素和兄弟元素
                                if (!name) {
                                    // 检查祖父元素的子元素中是否有name类
                                    const grandParent = parent.parentElement;
                                    if (grandParent) {
                                        // 查找父元素之后的兄弟元素中的name类
                                        let foundParent = false;
                                        for (let i = 0; i < grandParent.children.length; i++) {
                                            const child = grandParent.children[i];
                                            if (foundParent && child.classList && child.classList.contains('name')) {
                                                name = child.textContent.trim();
                                                console.log('找到名称(方法3-祖父元素子元素):', name);
                                                break;
                                            }
                                            if (child === parent) {
                                                foundParent = true;
                                            }
                                        }
                                        
                                        // 检查img的兄弟元素的子元素是否有name类
                                        if (!name) {
                                            const siblings = Array.from(parent.parentElement.children);
                                            for (const sibling of siblings) {
                                                if (sibling !== parent) {
                                                    const nameDiv = sibling.querySelector('.name');
                                                    if (nameDiv) {
                                                        name = nameDiv.textContent.trim();
                                                        console.log('找到名称(方法4-兄弟元素子元素):', name);
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            
                            // 如果所有方法都失败，尝试在整个文档中查找最近的name类元素
                            if (!name) {
                                const allNameDivs = doc.querySelectorAll('.name');
                                console.log('找到所有name元素数量:', allNameDivs.length);
                                
                                if (allNameDivs.length > 0) {
                                    // 找到与当前图片最接近的name元素
                                    let closestNameDiv = null;
                                    let minDistance = Infinity;
                                    
                                    // 遍历所有name元素，找到最近的一个
                                    for (const nameDiv of allNameDivs) {
                                        // 计算简单的"接近度"（只考虑文档顺序）
                                        // 在实际浏览器环境中，可以使用getBoundingClientRect()计算真实距离
                                        const distance = Math.abs(
                                            Array.from(doc.querySelectorAll('*')).indexOf(nameDiv) - 
                                            Array.from(doc.querySelectorAll('*')).indexOf(img)
                                        );
                                        
                                        console.log('name元素距离:', nameDiv.textContent.trim(), distance);
                                        
                                        if (distance < minDistance) {
                                            minDistance = distance;
                                            closestNameDiv = nameDiv;
                                        }
                                    }
                                    
                                    if (closestNameDiv && minDistance < 20) { // 设置一个合理的阈值
                                        name = closestNameDiv.textContent.trim();
                                        console.log('找到名称(方法5-最近name元素):', name, '距离:', minDistance);
                                    }
                                }
                            }
                            
                            console.log('最终使用名称:', name || `image_${imageLinks.length + 1}`);
                            
                            // 存储图片URL和名称
                            imageLinks.push({
                                url: src,
                                name: name || `image_${imageLinks.length + 1}`
                            });
                        }
                    }
                });
                
                progressBar.style.width = '100%';
                progressBar.classList.add('bg-success');
                
                // 更新图片统计
                totalImages = imageLinks.length;
                updateStats('images');
                
                // 显示结果
                result.style.display = 'block';
                result.className = 'success';
                result.textContent = `共找到 ${imageLinks.length} 张图片`;
                
                if (imageLinks.length > 0) {
                    downloadBtn.style.display = 'inline-block';
                    previewContainer.style.display = 'block';
                    updateImagePreview();
                }
                
            } catch (error) {
                result.style.display = 'block';
                result.className = 'error';
                result.textContent = '发生错误：' + error.message;
                progressBar.style.width = '100%';
                progressBar.classList.add('bg-danger');
            } finally {
                button.disabled = false;
            }
        });
        
        function updateImagePreview() {
            const container = document.querySelector('.images-container');
            container.innerHTML = '';
            
            // 最多显示9张预览图
            const previewImages = imageLinks.slice(0, 9);
            
            previewImages.forEach(item => {
                const col = document.createElement('div');
                col.className = 'col-4';
                
                const imgContainer = document.createElement('div');
                imgContainer.className = 'img-preview-container';
                imgContainer.style.height = '100px';
                imgContainer.style.overflow = 'hidden';
                imgContainer.style.borderRadius = '8px';
                imgContainer.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                imgContainer.style.position = 'relative';
                
                const img = document.createElement('img');
                img.src = item.url;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                
                const nameOverlay = document.createElement('div');
                nameOverlay.className = 'name-overlay';
                nameOverlay.style.position = 'absolute';
                nameOverlay.style.bottom = '0';
                nameOverlay.style.left = '0';
                nameOverlay.style.right = '0';
                nameOverlay.style.padding = '5px';
                nameOverlay.style.backgroundColor = 'rgba(0,0,0,0.6)';
                nameOverlay.style.color = 'white';
                nameOverlay.style.fontSize = '10px';
                nameOverlay.style.overflow = 'hidden';
                nameOverlay.style.textOverflow = 'ellipsis';
                nameOverlay.style.whiteSpace = 'nowrap';
                nameOverlay.textContent = item.name;
                
                imgContainer.appendChild(img);
                imgContainer.appendChild(nameOverlay);
                col.appendChild(imgContainer);
                container.appendChild(col);
            });
            
            // 隐藏默认提示，显示预览
            document.getElementById('no-preview').style.display = 'none';
            document.getElementById('imagesPreview').style.display = 'block';
        }
        
        function downloadAllImages(items) {
            // 使用JSZip进行打包下载
            if (typeof JSZip === 'undefined') {
                // 如果JSZip未加载，先加载JSZip库
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                script.onload = function() {
                    executeDownload(items);
                };
                document.head.appendChild(script);
            } else {
                executeDownload(items);
            }
        }
        
        function executeDownload(items) {
            const zip = new JSZip();
            const folder = zip.folder("images");
            const downloadPromises = [];
            
            // 获取用户选择的格式和质量
            const formatOption = document.getElementById('imageFormat').value;
            const jpgQuality = parseFloat(document.getElementById('jpgQuality').value);
            
            items.forEach((item, index) => {
                // 获取文件扩展名
                const url = item.url;
                // 先从URL尝试获取扩展名
                let extension = url.split('.').pop().split('?')[0].toLowerCase();
                
                // 根据用户选择设置扩展名
                if (formatOption === 'jpg') {
                    extension = 'jpg';
                } else if (formatOption === 'png') {
                    extension = 'png';
                } else if (formatOption === 'svg') {
                    // 如果用户选择了SVG格式，检查是否为SVG文件
                    if (url.toLowerCase().endsWith('svg') || extension === 'svg') {
                        extension = 'svg';
                    } else {
                        // 如果不是SVG，默认使用jpg
                        extension = 'jpg';
                    }
                } else {
                    // 自动模式下，检查扩展名是否为常见图片格式
                    const validImgExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'];
                    if (!validImgExtensions.includes(extension)) {
                        extension = 'jpg'; // 默认使用jpg
                    }
                    
                    // 除非是svg格式，否则将webp, gif, bmp等转换为jpg或png
                    if (extension !== 'svg' && !['jpg', 'jpeg', 'png'].includes(extension)) {
                        extension = 'jpg';
                    }
                }
                
                // 处理文件名，移除非法字符
                let filename = item.name.replace(/[\\/:*?"<>|]/g, '_');
                // 如果文件名为空，使用index
                if (!filename.trim()) {
                    filename = `image_${index + 1}`;
                }
                
                console.log(`下载图片: ${url}, 使用名称: ${filename}, 格式: ${extension}`);
                
                // 添加扩展名
                let fileBaseName = filename;
                // 如果文件名已有扩展名，先去掉
                if (filename.includes('.')) {
                    fileBaseName = filename.substring(0, filename.lastIndexOf('.'));
                }
                filename = `${fileBaseName}.${extension}`;
                
                // 构建不含扩展名的文件名
                let fileName = filename.substring(0, filename.lastIndexOf('.'));
                
                // 添加到压缩包
                const promise = fetch(url)
                    .then(response => {
                        if (response.ok) {
                            // 获取Content-Type
                            const contentType = response.headers.get('content-type');
                            return response.blob().then(blob => {
                                // 检查是否为SVG格式
                                const isSvgFormat = (
                                    extension === 'svg' || 
                                    (contentType && contentType.includes('image/svg+xml')) ||
                                    (formatOption === 'svg' && formatOption !== 'jpg' && formatOption !== 'png')
                                );
                                
                                // 如果是SVG格式，检查内容并处理
                                if (isSvgFormat) {
                                    console.log('确认为SVG内容，保留SVG格式');
                                    
                                    // 获取用户指定的扩展名
                                    const extensionOption = document.getElementById('extensionSelect').value;
                                    
                                    // 确定文件扩展名
                                    let extension;
                                    if (extensionOption === 'auto') {
                                        extension = '.svg'; // SVG格式默认使用.svg扩展名
                                    } else if (extensionOption === 'original') {
                                        // 获取原始文件的扩展名
                                        const originalExt = item.name.split('.').pop();
                                        extension = originalExt ? '.' + originalExt : '.svg';
                                    } else if (extensionOption === 'custom') {
                                        // 使用用户自定义的扩展名
                                        const customExt = document.getElementById('customExtensionInput').value.trim();
                                        extension = customExt ? '.' + customExt.replace(/^\./, '') : '.svg';
                                    } else {
                                        // 使用用户选择的预设扩展名
                                        extension = '.' + extensionOption;
                                    }
                                    
                                    // 构建不含扩展名的文件名
                                    let fileName = item.name.substring(0, item.name.lastIndexOf('.'));
                                    // 移除原始扩展名
                                    if (fileName.lastIndexOf('.') !== -1) {
                                        fileName = fileName.substring(0, fileName.lastIndexOf('.'));
                                    }
                                    
                                    // 完整的文件名（带新扩展名）
                                    const newFileName = fileName + extension;
                                    
                                    return new Blob([text], {type: 'image/svg+xml'});
                                } else {
                                    console.log('内容不是SVG格式，使用默认处理');
                                    return blob;
                                }
                            }).catch(err => {
                                console.error('SVG内容检测失败:', err);
                                return blob;
                            });
                        }
                        throw new Error(`无法下载图片: ${url}`);
                    })
                    .then(blob => {
                        folder.file(filename, blob);
                        return true;
                    })
                    .catch(error => {
                        console.error(error);
                        return false;
                    });
                
                downloadPromises.push(promise);
            });
            
            // 进度显示
            const result = document.getElementById('imageResult');
            result.textContent = '正在准备下载...';
            
            Promise.all(downloadPromises).then(results => {
                const successCount = results.filter(Boolean).length;
                
                // 统计各种文件类型的数量
                const formatStats = {};
                
                // 更新图片统计信息
                downloadedImages = successCount;
                failedImages = items.length - successCount;
                updateStats('images');
                
                zip.generateAsync({type:"blob"})
                    .then(function(content) {
                        // 使用FileSaver库下载
                        if (typeof saveAs === 'undefined') {
                            const script = document.createElement('script');
                            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js';
                            script.onload = function() {
                                saveAs(content, "images.zip");
                                result.textContent = `已下载 ${successCount}/${items.length} 张图片 (${formatOption === 'auto' ? '自动识别格式' : formatOption === 'svg' ? '保留SVG格式' : formatOption === 'jpg' ? '强制JPG格式' : '强制PNG格式'})`;
                            };
                            document.head.appendChild(script);
                        } else {
                            saveAs(content, "images.zip");
                            result.textContent = `已下载 ${successCount}/${items.length} 张图片 (${formatOption === 'auto' ? '自动识别格式' : formatOption === 'svg' ? '保留SVG格式' : formatOption === 'jpg' ? '强制JPG格式' : '强制PNG格式'})`;
                        }
                    });
            });
        }

        document.getElementById('downloadImagesBtn').addEventListener('click', function() {
            if (imageLinks.length > 0) {
                downloadAllImages(imageLinks);
            }
        });

        // 图片尺寸调整功能
        let uploadedImages = [];
        let resizedImages = [];

        // 监听宽度输入变化，根据选择的比例自动调整高度
        document.getElementById('widthInput').addEventListener('input', function() {
            const selectedRatio = document.querySelector('input[name="aspectRatio"]:checked').value;
            const width = parseInt(this.value) || 0;
            
            if (selectedRatio === "16:9") {
                const height = Math.round(width * 9 / 16);
                document.getElementById('heightInput').value = height;
            } else if (selectedRatio === "4:3") {
                const height = Math.round(width * 3 / 4);
                document.getElementById('heightInput').value = height;
            } else if (selectedRatio === "1:1") {
                document.getElementById('heightInput').value = width;
            } else if (selectedRatio === "original" && uploadedImages.length > 0) {
                // 如果选择了保持原图比例并且已经上传了图片，使用第一张图的比例
                const firstImage = uploadedImages[0];
                createImageFromFile(firstImage).then(img => {
                    const ratio = img.height / img.width;
                    const height = Math.round(width * ratio);
                    document.getElementById('heightInput').value = height;
                });
            }
            // 如果是自定义尺寸（none），则不自动调整高度
        });

        // 监听高度输入变化，根据选择的比例自动调整宽度
        document.getElementById('heightInput').addEventListener('input', function() {
            const selectedRatio = document.querySelector('input[name="aspectRatio"]:checked').value;
            const height = parseInt(this.value) || 0;
            
            if (selectedRatio === "16:9") {
                const width = Math.round(height * 16 / 9);
                document.getElementById('widthInput').value = width;
            } else if (selectedRatio === "4:3") {
                const width = Math.round(height * 4 / 3);
                document.getElementById('widthInput').value = width;
            } else if (selectedRatio === "1:1") {
                document.getElementById('widthInput').value = height;
            } else if (selectedRatio === "original" && uploadedImages.length > 0) {
                // 如果选择了保持原图比例并且已经上传了图片，使用第一张图的比例
                const firstImage = uploadedImages[0];
                createImageFromFile(firstImage).then(img => {
                    const ratio = img.width / img.height;
                    const width = Math.round(height * ratio);
                    document.getElementById('widthInput').value = width;
                });
            }
            // 如果是自定义尺寸（none），则不自动调整宽度
        });

        // 监听比例选择变化
        document.querySelectorAll('input[name="aspectRatio"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const selectedRatio = this.value;
                const widthInput = document.getElementById('widthInput');
                const heightInput = document.getElementById('heightInput');
                const width = parseInt(widthInput.value) || 1280;
                
                if (selectedRatio === "none") {
                    // 自定义尺寸，不自动调整
                    return;
                } else if (selectedRatio === "16:9") {
                    heightInput.value = Math.round(width * 9 / 16);
                } else if (selectedRatio === "4:3") {
                    heightInput.value = Math.round(width * 3 / 4);
                } else if (selectedRatio === "1:1") {
                    heightInput.value = width;
                } else if (selectedRatio === "original" && uploadedImages.length > 0) {
                    // 如果已上传图片，获取第一张图的原始比例
                    const firstImage = uploadedImages[0];
                    createImageFromFile(firstImage).then(img => {
                        const ratio = img.height / img.width;
                        heightInput.value = Math.round(width * ratio);
                    });
                }
            });
        });

        // 监听图片上传
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                uploadedImages = Array.from(e.target.files);
                document.getElementById('resizeBtn').disabled = false;
                
                // 重置尺寸调整统计
                totalResizeImages = uploadedImages.length;
                resizedSuccessCount = 0;
                resizedFailCount = 0;
                updateStats('resize');
                
                // 如果选择了保持原图比例，更新高度
                const selectedRatio = document.querySelector('input[name="aspectRatio"]:checked').value;
                if (selectedRatio === "original") {
                    const firstImage = uploadedImages[0];
                    const width = parseInt(document.getElementById('widthInput').value) || 1280;
                    
                    createImageFromFile(firstImage).then(img => {
                        const ratio = img.height / img.width;
                        document.getElementById('heightInput').value = Math.round(width * ratio);
                    });
                }
            }
        });

        // 调整尺寸按钮点击事件
        document.getElementById('resizeBtn').addEventListener('click', function() {
            if (uploadedImages.length === 0) {
                alert('请先上传图片');
                return;
            }

            const width = parseInt(document.getElementById('widthInput').value) || 1280;
            const height = parseInt(document.getElementById('heightInput').value) || 720;
            
            const button = this;
            const progress = document.getElementById('resizeProgress');
            const progressBar = progress.querySelector('.progress-bar');
            
            button.disabled = true;
            progress.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.classList.remove('bg-success', 'bg-danger');
            
            resizedImages = [];
            resizeImages(uploadedImages, width, height)
                .then(results => {
                    resizedImages = results;
                    updateResizedImagesPreview();
                    progressBar.style.width = '100%';
                    progressBar.classList.add('bg-success');
                    
                    // 最终更新统计信息
                    updateStats('resize');
                })
                .catch(error => {
                    console.error('调整尺寸时发生错误:', error);
                    progressBar.style.width = '100%';
                    progressBar.classList.add('bg-danger');
                })
                .finally(() => {
                    button.disabled = false;
                });
        });

        // 调整图片尺寸
        async function resizeImages(images, targetWidth, targetHeight) {
            const results = [];
            const progress = document.getElementById('resizeProgress');
            const progressBar = progress.querySelector('.progress-bar');
            const selectedRatio = document.querySelector('input[name="aspectRatio"]:checked').value;
            
            // 重置统计
            resizedSuccessCount = 0;
            resizedFailCount = 0;
            totalResizeImages = images.length;
            updateStats('resize');
            
            // 添加格式选择功能
            const formatSelect = document.createElement('select');
            formatSelect.id = 'formatSelect';
            formatSelect.className = 'form-select form-select-sm';
            formatSelect.innerHTML = `
                <option value="image/jpeg" selected>JPG</option>
                <option value="image/png">PNG</option>
                <option value="image/svg+xml">SVG</option>
            `;
            
            // 添加后缀名选择功能
            const extensionSelect = document.createElement('select');
            extensionSelect.id = 'extensionSelect';
            extensionSelect.className = 'form-select form-select-sm';
            extensionSelect.innerHTML = `
                <option value="auto" selected>使用默认后缀</option>
                <option value="original">保留原始后缀</option>
                <option value="jpg">使用.jpg后缀</option>
                <option value="jpeg">使用.jpeg后缀</option>
                <option value="png">使用.png后缀</option>
                <option value="svg">使用.svg后缀</option>
                <option value="webp">使用.webp后缀</option>
                <option value="custom">自定义后缀</option>
            `;
            
            // 自定义后缀输入框
            const customExtensionInput = document.createElement('input');
            customExtensionInput.id = 'customExtensionInput';
            customExtensionInput.className = 'form-control form-control-sm mt-2';
            customExtensionInput.placeholder = '输入自定义后缀（不含点号）';
            customExtensionInput.style.display = 'none';
            
            // 如果不存在已添加过的格式选择器，则添加
            if (!document.getElementById('formatSelect')) {
                const formatContainer = document.createElement('div');
                formatContainer.className = 'mb-3';
                formatContainer.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <label for="formatSelect" class="form-label">输出格式</label>
                            <div id="formatSelectContainer"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="extensionSelect" class="form-label">输出文件后缀</label>
                            <div id="extensionSelectContainer"></div>
                        </div>
                    </div>
                `;
                
                const resizeBtn = document.getElementById('resizeBtn');
                resizeBtn.parentNode.insertBefore(formatContainer, resizeBtn);
                
                document.getElementById('formatSelectContainer').appendChild(formatSelect);
                document.getElementById('extensionSelectContainer').appendChild(extensionSelect);
                document.getElementById('extensionSelectContainer').appendChild(customExtensionInput);
                
                // 添加后缀选择事件监听
                extensionSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customExtensionInput.style.display = 'block';
                    } else {
                        customExtensionInput.style.display = 'none';
                    }
                });
            }
            
            // 获取所选格式
            const outputFormat = document.getElementById('formatSelect').value;
            
            for (let i = 0; i < images.length; i++) {
                const file = images[i];
                // 更新进度条
                const progressPercent = (i / images.length) * 100;
                progressBar.style.width = `${progressPercent}%`;
                
                try {
                    // 创建图片对象并加载
                    const image = await createImageFromFile(file);
                    
                    // 确定最终的宽度和高度
                    let finalWidth = targetWidth;
                    let finalHeight = targetHeight;
                    
                    // 如果选择了保持原图比例，则根据原图计算尺寸
                    if (selectedRatio === "original") {
                        const originalRatio = image.height / image.width;
                        finalHeight = Math.round(finalWidth * originalRatio);
                    }
                    
                    // 如果是SVG格式，不使用Canvas处理
                    if (outputFormat === 'image/svg+xml') {
                        // 对于SVG，不进行尺寸调整，直接使用原始文件
                        // SVG是矢量格式，可以在浏览器中自动缩放
                        // 如果需要调整SVG的尺寸，可以通过修改viewBox或添加width/height属性
                        const svgFile = file;
                        const svgUrl = URL.createObjectURL(svgFile);
                        
                        // 获取用户指定的扩展名
                        const extensionOption = document.getElementById('extensionSelect').value;
                        
                        // 确定文件扩展名
                        let extension;
                        if (extensionOption === 'auto') {
                            extension = '.svg'; // SVG格式默认使用.svg扩展名
                        } else if (extensionOption === 'original') {
                            // 获取原始文件的扩展名
                            const originalExt = file.name.split('.').pop();
                            extension = originalExt ? '.' + originalExt : '.svg';
                        } else if (extensionOption === 'custom') {
                            // 使用用户自定义的扩展名
                            const customExt = document.getElementById('customExtensionInput').value.trim();
                            extension = customExt ? '.' + customExt.replace(/^\./, '') : '.svg';
                        } else {
                            // 使用用户选择的预设扩展名
                            extension = '.' + extensionOption;
                        }
                        
                        // 构建不含扩展名的文件名
                        let fileName = file.name.substring(0, file.name.lastIndexOf('.'));
                        // 移除原始扩展名
                        if (fileName.lastIndexOf('.') !== -1) {
                            fileName = fileName.substring(0, fileName.lastIndexOf('.'));
                        }
                        
                        // 完整的文件名（带新扩展名）
                        const newFileName = fileName + extension;
                        
                        results.push({
                            original: file,
                            resized: svgFile, // 使用原始SVG文件
                            name: newFileName,
                            url: svgUrl,
                            width: finalWidth,
                            height: finalHeight,
                            mimeType: 'image/svg+xml'
                        });
                        
                        // 更新成功统计
                        resizedSuccessCount++;
                        updateStats('resize');
                        continue; // 跳过Canvas处理
                    }
                    
                    // 创建Canvas进行尺寸调整
                    const canvas = document.createElement('canvas');
                    canvas.width = finalWidth;
                    canvas.height = finalHeight;
                    const ctx = canvas.getContext('2d');
                    
                    // 绘制图片到Canvas
                    ctx.drawImage(image, 0, 0, finalWidth, finalHeight);
                    
                    // 获取调整后的图片，强制使用JPG或PNG格式
                    const blob = await new Promise(resolve => {
                        // 使用选择的格式，或者默认为JPEG
                        const mimeType = outputFormat || 'image/jpeg';
                        const quality = mimeType === 'image/jpeg' ? 0.9 : undefined; // JPEG需要压缩质量参数
                        canvas.toBlob(resolve, mimeType, quality);
                    });
                    
                    // 获取用户指定的扩展名
                    const extensionOption = document.getElementById('extensionSelect').value;
                    
                    // 确定文件扩展名
                    let extension;
                    if (extensionOption === 'auto') {
                        // 根据输出格式自动选择扩展名
                        if (outputFormat === 'image/png') {
                            extension = '.png';
                        } else if (outputFormat === 'image/svg+xml') {
                            extension = '.svg';
                        } else if (outputFormat === 'image/webp') {
                            extension = '.webp';
                        } else {
                            extension = '.jpg';
                        }
                    } else if (extensionOption === 'original') {
                        // 获取原始文件的扩展名
                        const originalExt = file.name.split('.').pop();
                        extension = originalExt ? '.' + originalExt : '.jpg';
                    } else if (extensionOption === 'custom') {
                        // 使用用户自定义的扩展名
                        const customExt = document.getElementById('customExtensionInput').value.trim();
                        extension = customExt ? '.' + customExt.replace(/^\./, '') : '.jpg';
                    } else {
                        // 使用用户选择的预设扩展名
                        extension = '.' + extensionOption;
                    }
                    
                    // 构建不含扩展名的文件名
                    let fileName = file.name.substring(0, file.name.lastIndexOf('.'));
                    // 移除原始扩展名
                    if (fileName.lastIndexOf('.') !== -1) {
                        fileName = fileName.substring(0, fileName.lastIndexOf('.'));
                    }
                    
                    // 完整的文件名（带新扩展名）
                    const newFileName = fileName + extension;
                    
                    results.push({
                        original: file,
                        resized: blob,
                        name: newFileName,
                        url: URL.createObjectURL(blob),
                        width: finalWidth,
                        height: finalHeight,
                        mimeType: outputFormat
                    });
                    
                    // 更新成功统计
                    resizedSuccessCount++;
                    updateStats('resize');
                } catch (error) {
                    console.error(`调整图片 ${file.name} 失败:`, error);
                    
                    // 更新失败统计
                    resizedFailCount++;
                    updateStats('resize');
                }
            }
            
            return results;
        }

        // 从文件创建图片对象
        function createImageFromFile(file) {
            return new Promise((resolve, reject) => {
                const image = new Image();
                image.onload = () => resolve(image);
                image.onerror = reject;
                image.src = URL.createObjectURL(file);
            });
        }

        // 更新调整后的图片预览
        function updateResizedImagesPreview() {
            const container = document.querySelector('.resized-images-container');
            const previewContainer = document.getElementById('resizedImagesPreview');
            const noPreview = document.getElementById('no-resize-preview');
            
            container.innerHTML = '';
            
            if (resizedImages.length === 0) {
                previewContainer.style.display = 'none';
                noPreview.style.display = 'block';
                return;
            }
            
            resizedImages.forEach((item, index) => {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-3';
                
                const card = document.createElement('div');
                card.className = 'card h-100';
                card.style.overflow = 'hidden';
                
                const imgContainer = document.createElement('div');
                imgContainer.style.height = '180px';
                imgContainer.style.overflow = 'hidden';
                
                const img = document.createElement('img');
                img.src = item.url;
                img.className = 'card-img-top';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';
                
                const cardTitle = document.createElement('h6');
                cardTitle.className = 'card-title text-truncate';
                cardTitle.title = item.name;
                cardTitle.textContent = item.name;
                
                const cardText = document.createElement('p');
                cardText.className = 'card-text small text-muted';
                cardText.textContent = `${item.width} × ${item.height}`;
                
                const downloadBtn = document.createElement('a');
                downloadBtn.href = item.url;
                downloadBtn.className = 'btn btn-sm btn-outline-primary';
                downloadBtn.download = item.name;
                downloadBtn.innerHTML = `<i class="bi bi-download"></i> 下载 (${item.name.split('.').pop()})`;
                
                imgContainer.appendChild(img);
                cardBody.appendChild(cardTitle);
                cardBody.appendChild(cardText);
                cardBody.appendChild(downloadBtn);
                
                card.appendChild(imgContainer);
                card.appendChild(cardBody);
                col.appendChild(card);
                container.appendChild(col);
            });
            
            previewContainer.style.display = 'block';
            noPreview.style.display = 'none';
        }

        // 下载所有调整尺寸后的图片
        document.getElementById('downloadResizedBtn').addEventListener('click', function() {
            if (resizedImages.length === 0) {
                return;
            }
            
            // 使用JSZip进行打包下载
            if (typeof JSZip === 'undefined') {
                // 如果JSZip未加载，先加载JSZip库
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                script.onload = function() {
                    downloadResizedImages();
                };
                document.head.appendChild(script);
            } else {
                downloadResizedImages();
            }
        });

        function downloadResizedImages() {
            const zip = new JSZip();
            const folder = zip.folder("images");
            
            resizedImages.forEach((item, index) => {
                folder.file(item.name, item.resized);
            });
            
            zip.generateAsync({type:"blob"})
                .then(function(content) {
                    // 使用FileSaver库下载
                    if (typeof saveAs === 'undefined') {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js';
                        script.onload = function() {
                            saveAs(content, "images.zip");
                        };
                        document.head.appendChild(script);
                    } else {
                        saveAs(content, "images.zip");
                    }
                });
        }
    </script>
</body>
</html> 